services:
  redis:
    image: redis:7
    networks: [app_network]

  kvrocks:
    image: apache/kvrocks:latest
    networks: [app_network]

  clamav:
    image: clamav/clamav
    volumes:
      - clamav-socket:/tmp
    networks: [app_network]
    environment:
    - HTTP_PROXY=${PROXY}
    - HTTPS_PROXY=${PROXY}
    - http_proxy=${PROXY}
    - https_proxy=${PROXY}    
    healthcheck:
      test: ["CMD", "clamdscan", "--config=/etc/clamav/clamd.conf", "--ping", "1"]
      interval: 10s
      timeout: 1s
      retries: 3
      start_period: 120s
      start_interval: 10s

  pandora:
    image: ghcr.io/pandora-analysis/pandora:latest
    depends_on: [redis, kvrocks, clamav]
    expose: ["6100"]
    environment:
      - PANDORA_REDIS_HOST=redis
      - PANDORA_KVROCKS_HOST=kvrocks
      - HTTP_PROXY=${PROXY}
      - HTTPS_PROXY=${PROXY}
      - http_proxy=${PROXY}
      - https_proxy=${PROXY}

   
    env_file:
      - ./docker/pandora/pandora.env
    volumes:
      # Persistent runtime data
      - pandora_cache:/pandora/cache
      - pandora_storage:/pandora/storage
      - clamav-socket:/var/run/clamav
      
      - ./docker/pandora/config/generic.json:/pandora/config/generic.json:ro
      - ./docker/pandora/workers:/pandora/pandora/workers:ro
      - ./docker/pandora/yara_rules:/pandora/yara_rules:ro
    networks: [app_network]

networks:
  app_network:
    external: true

volumes:
  pandora_cache:
  pandora_storage:
  clamav-socket:
